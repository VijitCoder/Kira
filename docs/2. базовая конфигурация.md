# Базовая конфигурация

## Константы

Все константы, используемые движком, объявлены в `index.php` (при использовании мастера приложения). Если не указано иное, считать константу с типом *string*.

**ROOT_PATH** - физический путь от корня тома (диска) к корневому каталогу сайта. Завершающий слеш. Кроссплатформа, все слеши приводятся в прямым.

**APP_NAMESPACE** - корень пространства имен приложения. Используется в автозагрузчике. Все классы приложения должны быть в его подпространстве. Это [требование стандарта PSR-4](http://www.php-fig.org/psr/psr-4/ru/) к автозагрузчику классов.

**APP_PATH** - физический каталог со скриптами приложения (корень). Кроме прочего, используется автозагрузчиком классов.

*Константы APP_NAMESPACE и APP_PATH в основном нужны движку и в сочетании дают гибкое управление приложением. Например, нужно переключиться на другую версию, она в соседнем каталоге. Переписываем APP_PATH. А если запускаем принципиально иное приложение, можно пространство имен вести от другого корня и переписать APP_NAMESPACE.*

**VIEWS_PATH** - физический путь к шаблонам приложения. Они могут быть где угодно, для этого и введена константа.

**MAIN_CONFIG** - путь к файлу основноЙ конфигурации приложения.

**DEBUG** ( *boolean* ) - флаг отладки.

## Автозагрузка классов

Используется автозагрузик Composer. Ищите подробности на оф.сайте.

Благодаря переходу на этот автозагручик мы получаем из коробки поддержку для любой организации классов в пространствах имен. Теперь можно использовать namespace-ы именно так, как было задумано: отделять логические блоки кода. Т.е. можно, например, завести каталог **[admin/]**, в его подкаталогах сложить нужные контроллеры, модели и т.д., но задать для всех них одно пространство имен - `app\admin`. Вот в чем смысл логического блока. Красота! Правда при этом придется с каждым новым классов вызывать

```sh
composer dump-autoload
```

И конечно, чтобы это работало, нужен правильный конфиг Composer. Типа этой части:

```json
...
"autoload": {
    "classmap": ["app/"]
}
...
```

Имхо, выгоды значительно больше, чем неудобств. Но дело ваше, можно придерживаться и строгости стандарта PSR-4.

## Конфигурация приложения

Путь к основному конфигурационному файлу приложения задается в константе **MAIN_CONFIG**. Сам файл конфигурации - php-скрипт, возвращающий ассоциативный массив.

**В именах ключей нельзя использовать точку**. Почему - рассказано ниже, см. *"Чтение конфига"*.

Пример конфига:
```PHP
$main = [
    'indexHandler' => 'app\controllers\MainController->welcome',

    'router' => [
        '404_handler'   => 'app\controllers\ErrorController',
        'routes'        => require 'routes.php',
    ],

    'db' => [
        // прим.: строка подключения, юзер и пароль задаются в env.php
        'options' => [
            PDO::ATTR_TIMEOUT => 10,
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
        ],
    ],

    'domain' => 'site.com',

    'admin_mail'   => 'admin@site.com',
    'noreply_mail' => 'noreply@site.com',

    'timezone' => 'Asia/Novosibirsk',
];

$env = require 'env.php'; // конфиг среды окружения (== конфиг конкретного сервера)

return kira\utils\Arrays::merge_recursive($main, $env, true);

```

Движку требуется несколько обязательных настроек (параметров). Так же существует несколько рекомендуемых параметров.

***indexHandler***  - **обязательная настройка**. Контроллер приложения по умолчанию. Полностью определённое имя класса (FQN), от корневого пространства имен. Так же нужно указать метод, если он отличается от дефолтного. См. пример выше.

***router*** - **обязательная настройка**. Подробнее см. док *"Роутинг > Конфигурация"*.

***db*** - условно-обязательная настройка. Требуется, только если приложение работает с базами данных через PDO, используя при этом функционал движка. Проще говоря, движок здесь ищет строку подключения и ключи к БД. Подробнее в доке "*DB*"

***log*** - необязательная настройка логера. Без нее логер будет работать с настройками по умолчанию, см. док *"Логер"*

***domain*** - необязательно. Если `Env::domain()` не найдет имя домена в $_SERVER['HTTP_HOST'], попытается прочитать его в этой настройке. На имя домена завязаны некоторые другие функции класса `\kira\web\Env`, см. док *"Среда окружения сайта"*.

***admin_mail*** - ящик админа, условно-обязательная настройка. Как минимум, логер шлет сообщения на мыло админу.

***noreply_mail*** - необязательная настройка. Адрес отправителя для автоматических писателей, типа логера.

***timezone*** - необязательная настройка. Часовой пояс сайта для PHP функций даты/времени. Значение должно быть строкой, понятной PHP, полный список поясов [здесь](http://php.net/manual/en/timezones.php). Если не задана, считается UTC.

*Прим: До PHP 7.0 нужно было явно задавать часовой пояс, если используются функции даты/времени. Это можно было сделать через вызов [date_default_timezone_set()](http://php.net/manual/en/function.date-default-timezone-set.php) или задать пояс в php.ini. В 7й версии требование стало необязательным, по умолчанию считается UTC.*


##### Часовые пояса и конфигурация приложения

В полном конфиге приложения вы встретите три(!) настройки часовых поясов:

- *timezone* - основной пояс сайта, как сказано выше.
- *log.php_timezone* - пояс для записей лога. Он может отличаться от времени сайта, подробнее в доке *"Логер"*.
- *db.mysql_timezone* - пояс MySQL-сессии. Подробнее в доке *"DB"*

### Чтение конфигурации

Статичный метод
```PHP
\kira\App::conf(string $key, bool $strict = true)
```

Ключ конфига указываем в первом параметре. Через точку можно указать вложенные конфиги, например `App::conf('db.options')`. Функция вернет значение по конечному ключу, в данном примере - массив PDO-параметров. В чем выгода указывать конечные ключи? Функция проверяет всю цепочку настроек на существование, не придется делать это в клиентском коде.

Очевидно, что использовать точку в именах ключей конфига нельзя, функция расценит ее, как разделитель и попытается найти вложенный массив по заданному имени.

Второй параметр, `$strict`, управляет реакцией на отстутствие настройки. Если он равен `true`, будет проброшено исключение `kira\exceptions\ConfigException`. Если отсутствие настройки некритично для приложения, тогда вторым параметром передаем `false` и функция вернет `NULL`.
