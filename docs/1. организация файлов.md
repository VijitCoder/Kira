# Файловая организация

## Движок

Каталог [engine/] 

Каждый скрипт движка сопровождается комментарием, поэтому тут не повторяю. Классов в движке немного, только самое основное. Наследовать от ядерных классов необязательно, но рекомендуется. 

***engine/***

Тут сложено то, что по логике либо отностится к ядру движка, либо просто не удалось типизировать :)

***engine/db/***

Классы работы с базами данных. Сейчас поддерживается только MySQL.

***engine/html/***

Шаблоны для внутреннего использования движка.

***engine/net/***

Классы для работы с сетевым обменом: получение запроса, отправка ответа, маршрутизация и сессия. Сессия не относится к сетевому обмену, конечно, но близко по смыслу, поэтому тут.

***engine/utils/***

Утилиты. В другой нотации - хелперы. Функции, без которых можно работать, но с ними - удобнее.

***engine/web/***

Классы для web-приложения. Суперконтроллер, модель формы.

## Мастер создания приложения

Каталог [install/]

Новое приложение можно создать через мастер. Если нет указанного каталога, значит его предусмотрительно удалил тот, кто воспользовался мастером ранее :)

Мастер может создать простое или мультиязычное приложение с базовой конфигурацией. Форма мастера хорошо документирована, трудностей вызвать не должна. В процессе создания приложения пишется файл отката. Используя его, мастер может откатить свою деятельность. После работы мастера будет ссылка для отката установки или удаления этого файла. 

**Удалите файл отката, если не собираетесь отменять работу мастера.** Если этого не сделать, то случайный или намеренный вызов процедуры отката может привести к потере вашего сайта. 

*Прим.: мастер приложения сам служит примером приложения на этом движке.*

## Приложение

Жестких требований нет, организация файлов и каталогов - свободная, на усмотрение разработчка. См. док *"Базовая конфигурация > Автозагрузка..."*.

Если вы воспользовались мастером, то у вас будет примерно такая иерархия файлов и каталогов приложения:

***application/***

каталог приложения (сайта). Название - на свое усмотрение, см. константу **APP_PATH**.

***application/conf/main.php***

главный конфиг приложения. Определяется в константе **MAIN_CONFIG** Описание минимальной конфигурации см. в доке *"Базовая конфигурация > Конфиг приложения"*. 

***application/i18n/XX.php***

появится при использовании возможностей движка по локализации сайта. Файлы **xx.php** - языковые пакеты. Подробнее о локализации см. доке *"Локализация сайта"*

***application/temp/*** 

Временный каталог приложения. Определяется в константе **TEMP_PATH**. В него, как минимум, складываются логи. Для надежности можно запретить доступ запросами браузера, разместив в *temp*-каталоге файл `.htaccess`:

```Apache
<Files *.*>
   deny from all
</Files>
```

В случае использования другого веб-сервера ищите ответы в его мануалах. 

***application/views/*** 

каталог с представлениями (шаблонами) приложения. Определяется в константе **VIEWS_PATH**.

***application/Env.php***

Унаследованный класс, см. док *"Среда окружения сайта"*

## Рекомендации

***.htaccess***

Уже ставшие классическим, условия невыгодны:

```Apache
RewriteEngine On
RewriteBase /
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule ^(.*)$ index.php [L,QSA]
```

Они проверяют **каждый запрос** в стиле *"если не файл и не каталог, то.."*. Выяснение этого "если" - это проверка физического существования файла/каталога. Дисковые операции - это долго, причем тут неоправданно.

Рекомендую использовать такой:

```Apache
RewriteEngine On
RewriteBase /
# Если запрос не совпадает с перечисленным - отправлять его в index.php
RewriteCond %{REQUEST_URI} !^/(index\.php|public/|views/assets/|robots\.txt|sitemap\.xml)
RewriteRule .* index.php [L,QSA]
```

Еще один плюс такого правила - запрещено прямое обращение к скриптам (в отличие от "классики"), все они пойдут через *index.php*. Не забудьте перенести **favicon.ico** в `images/` или добавить его в условие.

Так же можно настроить страницы с ошибками 

```Apache
ErrorDocument 401 /ErrorController
ErrorDocument 403 /ErrorController
ErrorDocument 404 /ErrorController
ErrorDocument 500 /ErrorController
```
 
чтобы и движок и Apache реагировали одинаковыми страницами в стиле сайта. См. док *"Перехват http-ошибок"*.

В каталогах статики рекомендую настраивать права доступа к файлам *0666*, запрещая их исполнение. Так же не помешает настройка web-сервера на запрет выполнения файлов статики, как скриптов. Для этого в каталоге статики создайте свой `.htaccess`:

```Apache
php_flag engine 0
AddType "text/html" .php .cgi .pl .fcgi .fpl .phtml .shtml .php2 .php3 .php4 .php5 .asp .jsp
```

Будет работать, пока хакеры не перепищут этот файл :) И проверьте запрет доступа к этому файлу через веб. Обычно конфигурация сервера защищает .ht-файлы от чтения.

Я предлагаю такой вариант конфигурации web-сервера для простых случаев, когда у вас только Apache порт слушает. Если же статикой рулит *nginx* с проксированием остальных запросов в *Apache*, то мне еще у вас учиться, а не рекомендации давать :)
