# Генерация API документации движка

Для генерации используются комментарии в классах и методах движка.

Плохо обстоят дела с генераторами документации. Сначала я пользовался `Apigen`, потом перешел на `Sami`.

## Apigen

[Гитхаб](https://github.com/ApiGen/ApiGen)

Судя по датам коммитов и целом состоянии репа - проект сдох.

Конфиг [kira/docs/conf/apigen_vendor.neon].

Вызов:

```sh
# генерация для исходного проекта движка
vendor/bin/apigen generate --config ./docs/conf/apigen.neon

# генерация в составе вендорных библиотек приложения
vendor/bin/apigen generate --config ./vendor/vijitcoder/kira/docs/conf/apigen_vendor.neon
```

*Можно добавить ключ `-o, --overwrite` для автоматической перезаписи документации. Но это только в dev-версии генератора.*

Первый вариант подходит для генерации в проекте, где сам движок и есть - проект. Т.е. это для меня (Vijit), как разработчика движка. Второй вызов для генерации документации в конечном приложении. При этом в приложении должна быть добавлена зависимость:

```sh
composer require apigen/apigen
```

Замысел такой: в конечном приложении используется Kira. Ставим doc-генератор, собираем документацию, делаем симлинк куда-то подближе на каталог [vendor/vijitcoder/kira/docs/], пользуемся. Конечно, когда-нибудь возможно я запущу отдельный сайт для этого творения. Но пока только так.

Кстати, тут есть одна маленькая проблема: после `composer update` сгенерированная ранее документация исчезнет.. М-да, засада :) Решается добавлением в конфиг composer.json вашего приложения такой вот части:

```json
 "scripts": {
    "post-update-cmd":[
        "vendor/bin/apigen generate --config ./vendor/vijitcoder/kira/docs/conf/apigen_vendor.neon"
    ]
 }
```

Конечно, я мог бы прописать это в конфиге движка. Но вдруг кому-то эта документация будет по-боку, зачем ему лишняя генерация.

#### Баги

На данный момент я нашел у `apigen` следующие баги:

- `@method`, описание метода с двумя параметрами не попадает в документацию. Пример, `net/Request`, методы типа `getAsRegexp(string $key, string $pattern)`.
- `@see`, не парсятся ссылки. Зато если указать `class::method`, ссылка получается, но никуда не ведет.
- какие-то ошибки без явного указания, что не так. Я смог найти только упоминание про ColorConsole. Заколеб меня этот генератор, перешел на Sami.

Я пользовался dev-версией, но "stable" не лучше.

## Sami

[Старая статья](http://fabien.potencier.org/sami-yet-another-php-api-documentation-generator.html)
[Гитхаб](https://github.com/FriendsOfPHP/sami)

Настраивается через php-скрипт.
Конфиг для меня, как разрабочика [kira/docs/conf/sami.php]
Конфиг для приложения [kira/docs/conf/sami_vendor.php]

Установка через Composer:

```sh
composer require --dev semi/semi
```

Генерация. Вызов из корня сайта:

```sh
# генерация для исходного проекта движка
php vendor/bin/sami.php update docs/conf/sami.php

# генерация в составе вендорных библиотек приложения
php vendor/bin/sami.php update vendor/vijitcoder/kira/docs/conf/sami_vendor.php
```

В приложении можно добавить автогенерацию после обновления Composer. В конфиг composer.json приложения прописать:

```json
 "scripts": {
    "post-update-cmd":[
        "php vendor/bin/sami.php update vendor/vijitcoder/kira/docs/conf/sami_vendor.php"
    ]
 }
```

Нет нормальной документации по использованию генератора. Инфу собирал из readme.md в репе, старой статьи и наугад. Что выдается в консоль при сборке - могу только догадываться. (*Updated C, Updated N* - хрен-знает, че это).

Чтобы заставить генератор пересобрать документацию, нужно вручную удалить каталоги [build/] и [cache/] в каталоге документации. Да, а вы как хотели? Ключ в вызове генератора? А вот фиг вам..

После нескольких часов шаманства кое-как удалось получить стабильную версию документации.

Для этого прежде всего нужно отказаться от генерации по версиям. Это жутко глючая фича генератора. Для генерации по версиям все изменения должны быть закоммичены, причем похоже на удаленный реп тоже! Генератор будет переключать версии.

Если не использовать версионирование, то будет генерация **по текущему коду!**. Т.е. без версионирования генератор  в принципе не лезет к управлению ветками.

#### Баги

- не парсятся ссылки типа {@link URL title} в описании класса.

Эти баги вылазят, если пытаться получить документацию по версиям:

- левые классы в `master`. Т.е. в версии "master" я вижу класс из "development". Я предполагаю, генератор не из той ветки исходники берет.
- ссылки на исходники с указанием строки ломаются. То слеш потеряется, то вообще че-то невразумительное собирается; в каких-то случах не то номера строк получались.
