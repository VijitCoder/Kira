# Консоль Convisor

Простой менеджер запуска скриптов приложения из консоли. Область применения - какая угодно :) Название собрал из **Con**sole + Super**visor**.

Полный формат запуска:

```PHP
/www/site/$ php convisor.php <script> <param1> ... <paramN> -k <key>
```

Не забываем закрывать в кавычки или экранировать спец.символы. Все-таки консоль (sh, cmd) - это иная среда.

В режиме отладки (`DEBUG == true`) можно запускать без ключа доступа, на боевом сервере - только с ключом. Ключ прописываем
в настройках приложения, об этом чуть ниже. Ключ можно передавать на любом месте в списке параметров, главное сохранить последовательность пары "-k \<key\>".

Имя скрипта можно указывать без расширения, все равно только с PHP работаем. Скрипт, как минимум, должен содержать
функцию `function run(array $params)`, без классовой обертки. Все параметры будут переданы в нее массивом. Скрипт должен
находиться в каталоге [APP_PATH/console/]. Обратите внимание, каталог таки "консоль" называется. Исторически так сложилось :)

Для ясности, болванка запускаемого скрипта:

```PHP
// APP_PATH/console/cron_task.php
function run(array $params) {
    ...
}
```

Вызов Convisor-а вообще без параметров: получение списка доступных скриптов для запуска. Но без ключа его получить можно только
в режиме отладки. Иначе должны быть как минимум два параметра "-k \<key\>".

## Контроль доступа

Можно настроить контроль доступа к запускаемым скриптам. При этом запуск любого скрипта потребует указание секретного ключа доступа. Количество ошибок считается.

Ключ и допустимое количество попыток прописываем в конфиге приложения:

```PHP
// env.php
'convisor' => [
     'ties' => int|0     // количество попыток получить доступ
     'key' => string|''  // ключ доступа
]
```

*Прим: по понятным причинам этот конфиг лучше описывать в env.php и не коммитить в реп.*

В дальнейшем можно добавить контроль на запрещенные/разрешенные IP, отдельные ключи на каждый скрипт и т.п. Пока не требуется, не реализую.

**Внимание!** При отсутствии этого конфига, а так же со значениями по умолчанию, запуск будет разрешен без контроля доступа. В режиме отладки запуск скриптов в любом случае разрешен без вопросов.


Если на сайте включено логирование, неудавшиеся попытки пишутся в лог с типом *'deny console'*, после NN попыток консоль вообще блокируется через файл [TEMP_PATH/convisor.lock], при блокировке админу пойдет письмо.

После удачного получения доступа, файл блокировки (он же собственно считает попытки) будет удален.

#### Для информации

Менеджер состоит из двух файлов:
- `src\core\Convisor.php` - супер-класс менеджера;
- в корне приложения - `convisor.php`. Это аналог главного `index.php`.
