# DB. Конфигурация

Конфигураций БД может быть несколько, описываются в настройках приложения. По умолчанию ключ *"db"*, другие конфиги можно описать произвольными ключами и указывать их в конструкторе `DbModel`. Рекомендую придерживаться соглашения: ключи конфигов базы данных имеют префикс *"db_"*.

Шаблон конфигурации БД:

```php
 'db' => [
    'dsn'            => string,
    'user'           => string,
    'password'       => string,
    'options'        => array | []
    'mysql_timezone' => string | '+00:00'
 ]
```

Обычно конфигурация c конфиденциальной информацией описывается в отдельном файле и не контролируется СКВ. По умолчанию мастер приложения (см. док *"Организация файлов > Мастер создания приложения"*) создает конфиг в `env.php`.

Почти все параметры соответствуют параметрам конструктора класса [PDO](http://php.net/manual/en/pdo.construct.php).

Про *"options"* можно почитать в [PDO::setAttribute()](http://php.net/manual/ru/pdo.setattribute.php).

*Прим.: несмотря на то, что **ключи** в PDO Options представляют собой **числовые константы**, массив настроек, описанный в `env.php`, успешно сливается c главным конфигом. Обеспечено особым методом движка, и об этом заботиться не нужно.*

### Часовой пояс в MySQL-сессии

Полезные ссылки
waredom.ru: [Время в MySQL](http://waredom.ru/36#mysql)
stackoverflow.com: [How do I get the current time zone of MySQL?](http://stackoverflow.com/a/2934271/5497749)
stackoverflow.com: [Should MySQL have its timezone set to UTC?](http://stackoverflow.com/a/19075291/5497749)

Коротко, в чем смысл:

- если значение даты/времени задается функцией `mysql::now()` или ее аналогами, то его вычисление времени зависит от пояса сервера. При этом не важен тип поля, просто при вычислении значения для него учитывается часовой пояс сервера.
- при записи даты/времени в поле типа DATE, DATETIME часовой пояс в значении ни как не сохраняется. Это постоянное значение, результат чтения не зависит от текущего пояса сервера.
- запись в поле TIMESTAMP при сохранении переводится внутри MySQL в UTC, но при чтении значение опять переводится в *текущий пояс* MySQL-сервера. И не факт, что пояс при записи и чтении будет один и тот же.

Следовательно, при работе с полями типа TIMESTAMP нужно помнить про перевод из/в текущий часовой пояс севера. Если при этом пояс отличается от GMT 00:00, то на результате может отразиться, например, летнее время в заданном часовом поясе на момент записи.. или чтения. Чтобы избежать путаницы в сохраненном значении, можно сразу выставить часовой пояс MySQL-сервера в ноль, а получаемые TIMESTAMP-значения переводить в нужный пояс по своему усмотрению.

Конечно если вы не согласны, тогда укажите в настройке приложения `mysql_timezone` желаемый часовой пояс. Формат значения должен быть понятен MySQL-серверу.

Если у вас есть доступ к MySQL-серверу, лучше сразу задать на нем требуемый часовой пояс. Потому что через PHP это будет дополнительный запрос при каждом соединении с базой:

```PHP
$dbh->prepare('SET time_zone = ?')->execute($conf['mysql_timezone']);
```

Только если в настройке `mysql_timezone` **пустая строка**, запрос не будет отправлен. Если настройки нет вообще, по умолчанию ее значение будет '+00:00' (GMT).

*Прим: префикс "mysql_" означает, что в случае, когда часовой пояс задается названием, он должен быть из списка поясов известных MySQL, таблица `mysql`.`time_zone`. В PHP названия поясов могут быть другими.*

### Как можно задать пояс для MySQL в соответствии со временем скриптов?

Часовой пояс для php-скриптов может быть задан в *php.ini (date.timezone)* или через вызов в скипте:

```PHP
date_default_timezone_set('Asia/Novosibirsk');
```

Числовое значение пояса (даже с учетом летнего времени) можно получить через `php::date('P')`. Т.o. пишем в настройке базы:

```
db => [
    'mysql_timezone' => date('P'),
]
```

Теперь сессия с сервером MySQL будет работать в часовом поясе скриптов сайта.
