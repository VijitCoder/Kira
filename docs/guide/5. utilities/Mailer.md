# Утилиты. Mailer

Класс `\kira\utils\Mailer`

Простой класс по отправке почты. Способен создать и отправить письмо любой сложности, с вложениями, прикрепленными файлами, разными версиями письма. Но в итоге функционал опирается на функцию `php::mail()`. Мне некогда писать свою низкоуровневую реализацию на сокетах.

Есть несколько RFС по стандарту электронных писем. Однако не все почтовые клиенты им следуют, да и не все сервера.

> Например, чтобы Thunderbird 38.5 увидел имя прикрепленного файла, нужно его указывать после MIME, причем в той же строке. Или после attachment, и опять же в той же строке. Странно, но только так работает.

Вопрос отправки писем имеет множество ньюансов. Если методы этого класса не работают в вашем случае - создавайте свои :) Ну или используйте сторонние библиотеки разной степени глючности и веса.

Полезно почитать

- [php::mail()](http://php.net/manual/ru/function.mail.php)
- [Как грамотно отправлять почту из скриптов](https://habrahabr.ru/post/17531/)
- [RFC 2047 - MIME. Part Three](http://www.faqs.org/rfcs/rfc2047.html): *"Message Header Extensions for Non-ASCII Text"*. Тут изложены требования к заголовкам писем, кодированию текста и разбивке на строки.

## Сложное письмо с вложениями

function __complex__(_string_ __$from__, _string_ __$to__, _string_ __$subject__, __$body__, _array_ __$files__ = [])): _bool_

<table>
    <tr><td><b>$from</b></td><td>от кого</td></tr>
    <tr><td><b>$to</b></td><td>кому</td></tr>
    <tr><td><b>$subject</b></td><td>тема письма</td></tr>
    <tr><td><b>$body</b></td><td>текст письма. Если массив, тогда [text|html|MIME-type => тест письма]</td></tr>
    <tr><td><b>$files</b></td><td>вложения. Смешанный массив</td></tr>
</table>

**Версии текстов письма**

Параметр `$body`. Можно указать несколько версий текста. Де-факто люди пишут *text* и *html* версии. Порядок включения текстов в письмо соответствует порядку их указания в массиве.

Пример описания версий письма:

```php
[
    'text' => ...,
    'html' => ...,
    'text/html; charset=win-1251' => ...  //тоже html, но в другой кодировке
]
```

Для ключей `text|html` будут установлены нужные заголовки Content-Type (кодировка utf-8). Любые другие ключи пропишутся в Content-Type как есть. Такие "другие" версии - эксперимент, не гарантирую их корректную работу со связанным контентом из вложений.

Если тело письма не является массивом, считаем его html-текстом и снабжаем заголовком `Content-Type: text/html; charset=utf-8`.

**Вложения**

Параметр `$files`. Можно вложить файлы. Можно добавить картинки в html-версию и так же их приложить к письму. Пример вложений:

```php
[
    0 => '/path/file.zip',
    1 => '/another/path/file.doc',
    '/images/head.png' => 'image/png',
    '/images/logo.jpg' => 'image/jpeg',
    28 => 'images/just_file.jpg',
]
```

Когда ключ числовой, файл будет описан как вложение с `Content-Type: application/octet-stream;`.

Если ключ строковый, тогда он указывает на картинку, значение - ее MIME-тип. Такие файлы будут вложены как данные,связанные с html-текстом письма (multipart/related). Подключить их можно через `src="cid:image_file"` в теге [img].

Замечания:

- встроенные в html картинки можно не передавать, как вложения, если прописывать в теге [img] полный URL к картинке-источнику. При этом почтовый клиент должен запросить их по заданному адресу.

- связи с картинками (multipart/related) оформляются только для версии письма, отмеченной "html". Как такие связи будут работать с другими версиями - я не знаю, официально не поддерживается.

## Баг

У себя на локалке обнаружил баг при подготовке строк заголовков согласно стандарта **RFC 2047 Part Thr**. В конце кодированного значения **From, To** и **Reply-To** добавляется имя моей машины:

> From: =?utf-8?b?0K7Qt9C10YAgT25lIDx1c2VyX29uZUBtYWlsLnJ1Pg==?=@Z710

Причем это не PHP, т.к. дамп готовых значений ничего лишнего не показывает. Если записать одинаковое значение в адрес отправителя и в тему письма, то этот хвост появляется только у адресов! Эта приписочка очевидно ломает адрес получателя и письмо не доходит. Либо программа `mail` гонит, либо сервис `postfix`, на котором я провожу тесты. Не знаю, как искать причину. Пока отключил кодирование заголовков. На боевом стоит проверить, если бага не будет, оставить функцию включенной.
