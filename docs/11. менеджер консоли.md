# Convisor

Convisor - простой менеджер запуска скриптов приложения из консоли. Область применения - какая угодно :) Название собрал из **Con**sole + Super**visor**.

Полный формат запуска:

```sh
/www/site/$ php convisor.php <script> <param1> ... <paramN> -k <key>
```

Не забываем закрывать в кавычки или экранировать спец.символы. Все-таки консоль (sh, cmd) - это иная среда.

**-k \<key\>** Ключ доступа, см. ниже раздел *"Контроль доступа"*.

**\<script\>** Имя скрипта можно указывать без расширения, все равно только с PHP работаем. Скрипт, как минимум, должен содержать функцию `function run(array $params)`, без классовой обертки. Все параметры будут переданы в нее массивом. Скрипт должен находиться в каталоге [KIRA_APP_PATH/console/] или его подкаталогах.

**\<param1\> ... \<paramN\>** Параметры, передаваемые в скрипт. Параметры парсятся в ассоциативный массив, если они начинаются с одного или двух минусов. Примеры - ниже.

Для ясности, болванка запускаемого скрипта:

```PHP
// KIRA_APP_PATH/console/cron_task.php
function run(array $params) {
    ...
}
```

## Контроль доступа

Можно настроить контроль доступа к запускаемым скриптам. При этом запуск любого скрипта потребует указания секретного ключа доступа. Количество ошибок считается.

Ключ и допустимое количество попыток прописываем в конфиге приложения:

```PHP
// env.php
'convisor' => [
     'ties' => int|0     // количество попыток получить доступ
     'key' => string|''  // ключ доступа
]
```

*Прим: по понятным причинам этот конфиг лучше описывать в env.php и не коммитить в реп.*

Ключ можно передавать на любом месте в списке параметров, главное сохранить последовательность пары "-k \<key\>".

**Внимание!** При отсутствии этого конфига, а так же со значениями по умолчанию, запуск скриптов будет разрешен без контроля доступа. В режиме отладки запуск скриптов в любом случае разрешен без контроля доступа.

Если на сайте включено логирование, неудавшиеся попытки пишутся в лог с типом *'deny console'*, после NN попыток Convisor вообще блокируется через файл [KIRA_TEMP_PATH/convisor.lock], при блокировке админу пойдет письмо.

После удачного получения доступа, файл блокировки (он же собственно считает попытки) будет удален.

## Примеры

**Пример #1**: Вызов без параметров

Вызов Convisor-а вообще без параметров: получение списка доступных скриптов для запуска. Но без ключа его получить можно только в режиме отладки. Иначе должны быть как минимум два параметра "-k \<key\>".

```sh
/www/site/$ php convisor.php
или
/www/site/$ php convisor.php -k 5$dfw34
```

**Пример #2**: простой массив параметров, без ключа доступа

```sh
/www/site/$ php convisor.php guns/shot.php glok 9 17
```

В метод `run()` скрипта `KIRA_APP_PATH/console/guns/shot.php` будет передано:

```PHP
[
    0 => 'glok',
    1 => 9,
    2 => 17,
]
```

Обратите внимание, как указан подкаталог. Не нужно писать полный путь от корня тома или сайта. Для Convisor корень всегда [KIRA_APP_PATH/console/].

**Пример #3**: ассоциативный массив параметров

```sh
/www/site/$ php convisor.php upd_news --debug -d 30/01/2017 --topic 'рядом или около' -k 463g$g5 ---bug --limit 10
```

В скрипте `KIRA_APP_PATH/console/upd_news.php` будет вызвана функция `run()` и в нее передан массив того вида:

```php
[
    '--debug  => null,
    '-d'      => '30/01/2017',
    '--topic' => 'рядом или около',
    0         => '---bug',
    '--limit' => '10',
]
```

Чем примечателен пример:
- Ключ доступа (`-k`) в параметрах не отражается.
- Параметр без значения (`--debug`) получает значение `NULL`.
- Ключ с бОльшим количеством минусов, чем возможно (`---bug`), воспринимается как обычное значение, а не ключ как таковой.
- независимо от типа значения, все превращается в строку, ну кроме `NULL` разумеется.

**Пример #4**: смешанный набор параметров

Указание смещанного набора параметоров так же допустимо, хотя не могу представить, какой в этом прок. Например:

```sh
/www/site/$ php convisor.php mixup.php -k1 val --debug -k2 bar 12 orphan -k3 5
```

Получим

```PHP
[
    '-k1'     => 'val'
    '--debug' => null
    '-k2'     => 'bar'
    0         => '12'
    1         => 'orphan'
    '-k3'     => '5'
]
```

#### Для информации

Менеджер состоит из двух файлов:
- `src\core\Convisor.php` - супер-класс менеджера;
- в корне приложения - `convisor.php`. Это аналог главного `index.php`.

Учитывая, что запуск Convisor происходит в консоли, скрипт выполняется через PHP-client, т.е. веб-сервер не оказывает ни какого влияния на его выполнение. В частности, не работают правила `mod_rewrite` (в случае веб-сервера Apache).
